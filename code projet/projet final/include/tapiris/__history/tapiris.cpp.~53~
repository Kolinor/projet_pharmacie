//---------------------------------------------------------------------------

#pragma hdrstop

#include "tapiris.h"
//---------------------------------------------------------------------------
#pragma package(smart_init)

tapiris::tapiris()
{
	pmodBus = new modBus();
}

tapiris::~tapiris()
{
	delete pmodBus;
	this->etatCapteur = false;
}

bool tapiris::connected(string adress, unsigned short port)
{
	bool connected = pmodBus->connected(adress,port);
    this->etatCapteur = true;
	Thread = CreateThread(NULL,0,this->capteur,this,0,NULL);
	return connected;
}

bool tapiris::activePiston(int piston)
{
	int npiston = piston;
	bool verif = false;
	unsigned int pist;
	if (npiston == 1) {
		pist = 6;
	}
	if (npiston == 2) {
		pist = 7;
	}
	if (npiston == 3) {
		pist = 5;
	}
	if (npiston <= 3 && npiston >= 1) {
		verif = pmodBus->writeWord(pist,1);
		//vpiston.push_back(npiston);
		Thread = CreateThread(NULL,0,this->piston,new ThreadDataTapiris(piston, this),0,NULL);
	}
	return verif;
}

DWORD WINAPI tapiris::piston(LPVOID lpParam)
{
	ThreadDataTapiris * piston = (ThreadDataTapiris*)lpParam;
	Sleep(300);

	unsigned int pist;
	if (piston->piston == 1) {
		pist = 6;
	}
	if (piston->piston == 2) {
		pist = 7;
	}
	if (piston->piston == 3) {
		pist = 5;
	}

	piston->tapis->pmodBus->writeWord(pist,0);
	delete piston;
	return 0;
}

bool tapiris::activeTapis()
{
	bool verif = pmodBus->writeWord(0000,0000);
	return verif;
}

bool tapiris::deactivateTapis()
{
	bool verif = pmodBus->writeWord(0000,0001);
	return verif;
}

bool tapiris::deactivatePiston(int piston)
{
	int npiston = piston;
	bool verif = false;
	unsigned int pist;
	if (npiston == 1) {
		pist = 0006;
	}
	if (npiston == 2) {
		pist = 0007;
	}
	if (npiston == 3) {
		pist = 0005;
	}
	if (npiston <= 3 && npiston >= 1) {
		verif = pmodBus->writeWord(pist,0000);
	}
	return verif;
}


DWORD WINAPI tapiris::capteur(LPVOID lpParam)
{
	tapiris * capteur = (tapiris*)lpParam;

//	unsigned char * buffer = new unsigned char[4096];
	char * buffer = new char[15];
	bool test = true;
	int bytes;
	while(capteur->etatCapteur == true || test == false)
	{
		ZeroMemory(buffer, 4096);
		test = capteur->pmodBus->readWord(3,3,&buffer);

//		char * buf = new char[4096];
//		wcstombs(buffer,buf.c_str(),strlen(buffer));
//        char t = buffer[14];

		if (buffer[14] == 1) {
			capteur->activePiston(1);
		}
		if (buffer[12] == 1) {
			capteur->activePiston(2);
		}
		if (buffer[10] == 1) {
			capteur->activePiston(3);
		}
        Sleep(500);
	}
	return 0;
}
